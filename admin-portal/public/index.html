<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IVR Admin Portal - Call Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e4e4e4;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    header h1 {
      font-size: 1.8rem;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    header h1::before {
      content: "üìû";
      font-size: 1.5rem;
    }
    
    .refresh-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: transform 0.2s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card .icon {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 5px;
    }
    
    .stat-card .label {
      font-size: 0.9rem;
      color: #a0a0a0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-card.total { border-left: 4px solid #667eea; }
    .stat-card.unique { border-left: 4px solid #f093fb; }
    .stat-card.avg { border-left: 4px solid #4facfe; }
    .stat-card.max { border-left: 4px solid #43e97b; }
    .stat-card.min { border-left: 4px solid #fa709a; }
    .stat-card.sum { border-left: 4px solid #ffecd2; }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 1000px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card h2 {
      font-size: 1.2rem;
      color: #fff;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-container {
      height: 250px;
      position: relative;
    }
    
    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 200px;
      padding: 10px 0;
      gap: 8px;
    }
    
    .bar-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      max-width: 50px;
    }
    
    .bar {
      background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
      border-radius: 5px 5px 0 0;
      width: 100%;
      min-height: 5px;
      transition: height 0.5s ease;
    }
    
    .bar-label {
      font-size: 0.7rem;
      color: #a0a0a0;
      margin-top: 8px;
      text-align: center;
      transform: rotate(-45deg);
      white-space: nowrap;
    }
    
    .bar-value {
      font-size: 0.75rem;
      color: #fff;
      margin-bottom: 5px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table th,
    table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    table th {
      color: #a0a0a0;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 1px;
    }
    
    table td {
      color: #e4e4e4;
    }
    
    table tr:hover {
      background: rgba(255, 255, 255, 0.03);
    }
    
    .account-badge {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      padding: 4px 10px;
      border-radius: 20px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    
    .balance-amount {
      color: #43e97b;
      font-weight: 600;
    }
    
    .date-time {
      color: #a0a0a0;
      font-size: 0.85rem;
    }
    
    .call-logs-section {
      margin-top: 30px;
    }
    
    .call-logs-section .card {
      overflow-x: auto;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    
    .pagination button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination span {
      padding: 8px 16px;
      color: #a0a0a0;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #a0a0a0;
    }
    
    .loading::after {
      content: "";
      animation: dots 1.5s infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: "."; }
      40% { content: ".."; }
      60%, 100% { content: "..."; }
    }
    
    .error {
      background: rgba(250, 112, 154, 0.1);
      border: 1px solid #fa709a;
      color: #fa709a;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #a0a0a0;
    }
    
    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }
    
    .top-accounts-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .top-account-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
    }
    
    .top-account-item .account {
      font-family: monospace;
      color: #667eea;
    }
    
    .top-account-item .calls {
      background: rgba(102, 126, 234, 0.2);
      color: #fff;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.85rem;
    }
    
    .status-badge {
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-completed {
      background: rgba(67, 233, 123, 0.2);
      color: #43e97b;
    }
    
    .status-started {
      background: rgba(79, 172, 254, 0.2);
      color: #4facfe;
    }
    
    .status-account_entered {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }
    
    .status-abandoned, .status-invalid_account, .status-no_confirmation, .status-error {
      background: rgba(250, 112, 154, 0.2);
      color: #fa709a;
    }
    
    .status-breakdown {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
    }
    
    .status-item .count {
      font-weight: 700;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>IVR Call Dashboard</h1>
      <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
    </header>
    
    <div id="stats-section" class="stats-grid">
      <div class="loading">Loading statistics</div>
    </div>
    
    <div class="card" style="margin-bottom: 30px;">
      <h2>üìà Call Status Breakdown</h2>
      <div id="status-breakdown" class="status-breakdown">
        <div class="loading">Loading</div>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <div class="card">
        <h2>üìä Calls by Date (Last 30 Days)</h2>
        <div id="chart-section" class="chart-container">
          <div class="loading">Loading chart</div>
        </div>
      </div>
      
      <div class="card">
        <h2>üèÜ Top Calling Accounts</h2>
        <div id="top-accounts-section">
          <div class="loading">Loading</div>
        </div>
      </div>
    </div>
    
    <div class="call-logs-section">
      <div class="card">
        <h2>üìã Recent Call Logs</h2>
        <div id="logs-section">
          <div class="loading">Loading call logs</div>
        </div>
        <div id="pagination" class="pagination" style="display: none;">
          <button id="prev-btn" onclick="prevPage()">‚Üê Previous</button>
          <span id="page-info"></span>
          <button id="next-btn" onclick="nextPage()">Next ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 0;
    const pageSize = 15;
    let totalLogs = 0;
    
    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        if (!response.ok) throw new Error('Failed to load stats');
        const data = await response.json();
        
        renderStats(data);
        renderChart(data.callsByDate || []);
        renderTopAccounts(data.topAccounts || []);
        renderStatusBreakdown(data.callsByStatus || []);
      } catch (err) {
        document.getElementById('stats-section').innerHTML = 
          `<div class="error">Failed to load statistics: ${err.message}</div>`;
      }
    }
    
    async function loadLogs() {
      try {
        const response = await fetch(`/api/call-logs?limit=${pageSize}&offset=${currentPage * pageSize}`);
        if (!response.ok) throw new Error('Failed to load logs');
        const data = await response.json();
        
        totalLogs = data.total;
        renderLogs(data.logs || []);
        updatePagination();
      } catch (err) {
        document.getElementById('logs-section').innerHTML = 
          `<div class="error">Failed to load call logs: ${err.message}</div>`;
      }
    }
    
    function renderStats(stats) {
      const html = `
        <div class="stat-card total">
          <div class="icon">üìû</div>
          <div class="value">${stats.total_calls || 0}</div>
          <div class="label">Total Calls</div>
        </div>
        <div class="stat-card unique">
          <div class="icon">üë§</div>
          <div class="value">${stats.unique_accounts || 0}</div>
          <div class="label">Unique Accounts</div>
        </div>
        <div class="stat-card avg">
          <div class="icon">üìà</div>
          <div class="value">${formatCurrency(stats.avg_balance || 0)}</div>
          <div class="label">Avg Balance</div>
        </div>
        <div class="stat-card max">
          <div class="icon">‚¨ÜÔ∏è</div>
          <div class="value">${formatCurrency(stats.max_balance || 0)}</div>
          <div class="label">Max Balance</div>
        </div>
        <div class="stat-card min">
          <div class="icon">‚¨áÔ∏è</div>
          <div class="value">${formatCurrency(stats.min_balance || 0)}</div>
          <div class="label">Min Balance</div>
        </div>
        <div class="stat-card sum">
          <div class="icon">üí∞</div>
          <div class="value">${formatCurrency(stats.total_balance || 0)}</div>
          <div class="label">Total Balance</div>
        </div>
      `;
      document.getElementById('stats-section').innerHTML = html;
    }
    
    function renderChart(callsByDate) {
      if (!callsByDate.length) {
        document.getElementById('chart-section').innerHTML = 
          '<div class="empty-state"><div class="icon">üìä</div><p>No data available yet</p></div>';
        return;
      }
      
      // Reverse to show oldest first
      const data = [...callsByDate].reverse().slice(-14);
      const maxCalls = Math.max(...data.map(d => d.call_count), 1);
      
      const barsHtml = data.map(d => {
        const height = (d.call_count / maxCalls) * 180;
        const date = new Date(d.date);
        const label = `${date.getMonth() + 1}/${date.getDate()}`;
        return `
          <div class="bar-wrapper">
            <div class="bar-value">${d.call_count}</div>
            <div class="bar" style="height: ${height}px" title="${d.date}: ${d.call_count} calls"></div>
            <div class="bar-label">${label}</div>
          </div>
        `;
      }).join('');
      
      document.getElementById('chart-section').innerHTML = `<div class="bar-chart">${barsHtml}</div>`;
    }
    
    function renderTopAccounts(accounts) {
      if (!accounts.length) {
        document.getElementById('top-accounts-section').innerHTML = 
          '<div class="empty-state"><p>No accounts yet</p></div>';
        return;
      }
      
      const html = accounts.map(a => `
        <div class="top-account-item">
          <span class="account">${maskAccount(a.account_number)}</span>
          <span class="calls">${a.call_count} calls</span>
        </div>
      `).join('');
      
      document.getElementById('top-accounts-section').innerHTML = 
        `<div class="top-accounts-list">${html}</div>`;
    }
    
    function renderLogs(logs) {
      if (!logs.length) {
        document.getElementById('logs-section').innerHTML = 
          '<div class="empty-state"><div class="icon">üìã</div><p>No call logs recorded yet</p></div>';
        document.getElementById('pagination').style.display = 'none';
        return;
      }
      
      const rowsHtml = logs.map(log => `
        <tr>
          <td>${log.id}</td>
          <td><span class="status-badge status-${log.status || 'unknown'}">${formatStatus(log.status)}</span></td>
          <td>${log.account_number ? `<span class="account-badge">${maskAccount(log.account_number)}</span>` : '<span style="color:#666">-</span>'}</td>
          <td>${log.balance ? `<span class="balance-amount">${formatCurrency(log.balance)} ${log.currency || ''}</span>` : '<span style="color:#666">-</span>'}</td>
          <td><span class="date-time">${formatDateTime(log.call_date)}</span></td>
        </tr>
      `).join('');
      
      document.getElementById('logs-section').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Status</th>
              <th>Account Number</th>
              <th>Balance</th>
              <th>Date & Time</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
      
      document.getElementById('pagination').style.display = 'flex';
    }
    
    function formatStatus(status) {
      const labels = {
        'started': 'üîµ Started',
        'account_entered': 'üü° Account Entered',
        'completed': 'üü¢ Completed',
        'abandoned': 'üî¥ Abandoned',
        'invalid_account': 'üî¥ Invalid Account',
        'no_confirmation': 'üü† No Confirmation',
        'error': 'üî¥ Error',
        'balance_error': 'üî¥ Balance Error'
      };
      return labels[status] || status || 'Unknown';
    }
    
    function renderStatusBreakdown(callsByStatus) {
      if (!callsByStatus || !callsByStatus.length) return;
      
      const html = callsByStatus.map(s => `
        <div class="status-item">
          <span class="status-badge status-${s.status}">${formatStatus(s.status)}</span>
          <span class="count">${s.count}</span>
        </div>
      `).join('');
      
      document.getElementById('status-breakdown').innerHTML = html;
    }
    
    function updatePagination() {
      const totalPages = Math.ceil(totalLogs / pageSize);
      document.getElementById('page-info').textContent = 
        `Page ${currentPage + 1} of ${totalPages || 1} (${totalLogs} total)`;
      document.getElementById('prev-btn').disabled = currentPage === 0;
      document.getElementById('next-btn').disabled = currentPage >= totalPages - 1;
    }
    
    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        loadLogs();
      }
    }
    
    function nextPage() {
      const totalPages = Math.ceil(totalLogs / pageSize);
      if (currentPage < totalPages - 1) {
        currentPage++;
        loadLogs();
      }
    }
    
    function formatCurrency(value) {
      return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(value);
    }
    
    function formatDateTime(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    function maskAccount(account) {
      if (account.length <= 4) return account;
      return account.slice(0, 2) + '****' + account.slice(-4);
    }
    
    function loadData() {
      currentPage = 0;
      loadStats();
      loadLogs();
    }
    
    // Auto-refresh every 30 seconds
    setInterval(loadData, 30000);
    
    // Initial load
    loadData();
  </script>
</body>
</html>
