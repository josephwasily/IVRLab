# Minimal OpenSIPS config: forward REGISTER and INVITE to Asterisk on the ivrnet
# Built for OpenSIPS 3.4

# socket (replaces deprecated 'listen')
socket=udp:0.0.0.0:5060

# logging
log_level=3
stderror_enabled=yes

# load minimal modules
loadmodule "proto_udp.so"
loadmodule "signaling.so"
loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "sipmsgops.so"
loadmodule "nathelper.so"
loadmodule "rtpengine.so"

# module parameters
modparam("tm", "fr_timeout", 5)
modparam("tm", "fr_inv_timeout", 30)

# rtpengine parameters - connect to rtpengine container
modparam("rtpengine", "rtpengine_sock", "udp:rtpengine:2223")

# main request route
route {
    # max forwards check
    if (!mf_process_maxfwd_header(10)) {
        sl_send_reply(483, "Too Many Hops");
        exit;
    }

    # record-route for in-dialog requests
    if (is_method("INVITE|SUBSCRIBE")) {
        record_route();
    }

    # handle sequential requests (in-dialog)
    if (has_totag()) {
        if (loose_route()) {
            # For in-dialog requests, also handle RTP
            if (is_method("INVITE|ACK|BYE|CANCEL")) {
            # rtpengine_manage("replace-origin replace-session-connection");
            }
            t_relay();
            exit;
        }
    }

    # REGISTER: forward to Asterisk
    if (is_method("REGISTER")) {
        $du = "sip:asterisk:5060";
        t_relay();
        exit;
    }

    # INVITE: engage rtpengine and forward to Asterisk
    if (is_method("INVITE")) {
        # Use rtpengine to rewrite SDP (fix 127.0.0.1 media addresses)
        # rtpengine_offer("replace-origin replace-session-connection");
        # Replace the container IP with host IP in SDP
        # search_replace("IN IP4 172.21.0.1", "IN IP4 172.16.70.204");
        
        # Set up reply processing
        t_on_reply("MANAGE_REPLY");
    }

    # Forward to Asterisk
    $du = "sip:asterisk:5060";
    t_relay();
}

# reply route for managing SDP in responses
onreply_route[MANAGE_REPLY] {
    if (has_body("application/sdp")) {
        # rtpengine_answer("replace-origin replace-session-connection");
        # Replace the container IP with host IP in SDP
        # search_replace("IN IP4 172.21.0.1", "IN IP4 172.16.70.204");
    }
}

# failure route
failure_route[FAIL] {
    # Clean up rtpengine session on failure
    rtpengine_delete();
}
