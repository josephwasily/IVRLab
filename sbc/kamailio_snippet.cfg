/***************************************************
Example Kamailio snippet: rewrite 127.0.0.1 in SDP or anchor media via rtpengine

This is a lightweight example to integrate into your `kamailio.cfg` routing logic.
It is intentionally descriptive — adapt to your Kamailio version and modules.
***************************************************/

# 1) Load the modules you need in kamailio.cfg (example)
# loadmodule "rtpengine.so"  # if using rtpengine module
# loadmodule "textops.so"   # for body manipulation if required

# 2) In request_route or a specific route for INVITEs, before forwarding to Asterisk:
route[REWRITE_SDP_OR_ANCHOR] {
    if (is_method("INVITE") && has_body()) {
        # Inspect body for a connection address of 127.0.0.1
        $var(sdp) = $rb; # request body
        if ($var(sdp) =~ "127.0.0.1") {
            xlog("L_INFO", "Found 127.0.0.1 in SDP — rewriting to source IP $si\n");
            # Option A: Simple textual replacement (textops module may provide functions like subst())
            # NOTE: Replace the line(s) in the SDP that contain 127.0.0.1 with the packet source IP ($si).
            # Example (pseudocode — adapt to the textops API available in your Kamailio build):
            # $var(sdp) = subst($var(sdp), "127.0.0.1", $si);
            # remove_body(); append_body($var(sdp));

            # Option B (recommended): Anchor media using rtpengine (let rtpengine proxy the media)
            # This avoids manual SDP surgery and ensures media is anchored to a reachable IP.
            # Example (requires rtpengine module and rtpengine instances configured):
            # if (!rtpengine_offer()) {
            #    xlog("L_ERR", "rtpengine_offer failed\n");
            # }
            # When 200 OK arrives, call rtpengine_answer()
        }
    }

    # Continue normal routing (forward to Asterisk)
    route(RELAY);
}

# 3) On receiving 200 OK that contains SDP, you may need to call rtpengine_answer() if using rtpengine
# route[ON_200_OK] {
#    if (is_method("200") && has_body()) {
#        rtpengine_answer();
#    }
#}

# Important:
# - The snippet intentionally avoids exact function calls because module APIs and function names can vary across Kamailio versions.
# - Two practical approaches: (1) text-based SDP rewrite (less robust), (2) rtpengine/rtpproxy anchoring (robust).
# - If you'd like, I will produce a fully tested `kamailio.cfg` and pinned docker images that work with your Asterisk stack. Request that and I will implement and test it.